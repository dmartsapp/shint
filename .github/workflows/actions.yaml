name: Build go binary and release it

on:
  push:
    # branches:
    #   - main
    tags:
      - 'v*.*.*'

jobs:
  lint-and-vuln-check:
    name: Lint and Vulnerability Check
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      packages: write
      actions: read

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.TELNET_TOKEN }}
      - name: SonarQube Scan
        id: sonarqube-scan-check
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.CICD_SONAR_TOKEN }}

      - name: SonarQube Quality Gate
        id: sonarqube-quality-gate-check
        uses: SonarSource/sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.CICD_SONAR_TOKEN }}
          SONAR_PROJECT_KEY: farhansabbir_cicd
          SONAR_HOST_URL: https://sonarcloud.io

      - name: Summarize SonarQube job
        if: always()
        run: |
          echo "## ðŸ§ª SonarQube Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Checkout | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| SonarQube Scan | $([[ '${{ steps.sonarqube-scan-check.outcome }}' == 'success' ]] && echo âœ… Success || echo âŒ Failed) |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gate | $([[ '${{ steps.sonarqube-quality-gate-check.outcome }}' == 'success' ]] && echo âœ… Passed || echo âŒ Failed) |" >> $GITHUB_STEP_SUMMARY
      - uses: actions/setup-go@v6
        with:
          go-version: '>=1.25.1'
          check-latest: true
      - name: Download Go modules
        run: go mod tidy

      - name: Run linting
        id: golangci-lint
        uses: reviewdog/action-golangci-lint@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          fail_level: error
          level: info
      - name: Run vulnerability check
        id: govulncheck
        if: ${{ steps.golangci-lint.outcome == 'success' }}
        uses: golang/govulncheck-action@v1
        with:
          output-file: govulncheck-report.txt

      - name: Generate govulncheck summary
        if: always()
        run: |
            echo "## Vulnerability Report" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| **Status** | **Vulnerabilities Found** |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.govulncheck.conclusion }}" == "success" ]; then
                VULN_COUNT=$(grep 'Vulnerabilities found:' $GITHUB_WORKSPACE/govulncheck-report.txt | awk -F': ' '{print $2}')
                if [ "$VULN_COUNT" -gt 0 ]; then
                    echo "| âŒ Failure | ${VULN_COUNT} |" >> $GITHUB_STEP_SUMMARY
                else
                    echo "| âœ… Success | 0 |" >> $GITHUB_STEP_SUMMARY
                fi
            else
                echo "| âŒ Failure | Unknown (step failed) |" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Details" >> $GITHUB_STEP_SUMMARY
            echo "Checked modules: $(grep 'Checked modules:' $GITHUB_WORKSPACE/govulncheck-report.txt | awk -F': ' '{print $2}')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            grep -A 1000 'Details:' $GITHUB_WORKSPACE/govulncheck-report.txt >> $GITHUB_STEP_SUMMARY || true

  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: lint-and-vuln-check
    permissions:
      contents: write
      id-token: write
      packages: write
      actions: read
    strategy:
     fail-fast: false
     matrix:
       os: [darwin, linux, windows]
       arch: [amd64, arm64]
    #    exclude:
    #     - os: windows
    #       arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.TELNET_TOKEN }}
    
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
         go-version: '>=1.25.1'
         check-latest: true
      - name: Build binary for ${{ matrix.os }}/${{ matrix.arch }}
        id: build-step
        run: |
            mkdir -p bin
            GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -buildvcs=true -ldflags="-s -w -X main.Version=${{ github.ref_name }}/${{ github.sha }}" -o bin/tnt.${{ matrix.os }}.${{ matrix.arch }}${{ (matrix.os == 'windows' && '.exe') || '' }}

      - name: Upload artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
         name: binary-for-${{ matrix.os }}-${{ matrix.arch }}
         path: bin/

      - name: Generate build summary
        if: always()
        run: |
          echo "## Build Status for ${{ matrix.os }}/${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| **Binary** | **Status** |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
              echo "| âœ… tnt_${{ matrix.os }}_${{ matrix.arch }} | Success |" >> $GITHUB_STEP_SUMMARY
          else
              echo "| âŒ tnt_${{ matrix.os }}_${{ matrix.arch }} | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
      - name: Prepare summary for release body
        run: |
          cp $GITHUB_STEP_SUMMARY release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
        #   body: "Automated release for ${{ github.ref_name }}/${{ github.sha}}"
          body_path: ${{ github.workspace }}/release_notes.md
          append_body: true
          files: |
            bin/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Final Build Summary
        if: always()
        run: |
           echo "## Overall release status" >> $GITHUB_STEP_SUMMARY
           echo "" >> $GITHUB_STEP_SUMMARY
           echo "| **OS/Arch** | **Status** |" >> $GITHUB_STEP_SUMMARY
           echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
           for os in darwin linux windows; do
               for arch in amd64 arm64; do
                   echo "| $os/$arch | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
               done
           done
